@using GBX.NET
@using System.IO.Compression
@using GBX.NET.Exceptions

@inject ToolService ToolService
@inject IJSRuntime JS

@rendermode InteractiveAuto

<PageTitle>@GetTitle()</PageTitle>

<HeadContent>
    <meta property="og:title" content="@GetTitle()">
    <meta name="twitter:title" content="@GetTitle()">
</HeadContent>

<DragAndDrop Text="@(string.IsNullOrEmpty(Tool) ? TextWhenUnavailable : TextWhenAvailable)"
             SubText="@(string.IsNullOrEmpty(Tool) ? SubTextWhenUnavailable : SubTextWhenAvailable)"
             OnFile="OnFileAsync"
             OnDragEnd="OnDragEnd"
             Tool="Tool is null ? null : ToolService.GetTool(Tool)"></DragAndDrop>
<ToolMenu Highlight="HighlightToolMenu"></ToolMenu>

@if (TextOutput is not null)
{
    <TextOutput TextData="@TextOutput"></TextOutput>
}

@code {
    private const string TextWhenAvailable = "Drag and Drop";
    private const string SubTextWhenAvailable = "files, or CLICK to select files";

    private const string TextWhenUnavailable = "Select an I/O Tool";
    private const string SubTextWhenUnavailable = "on the left side, then import files";

    [Parameter]
    public string? Tool { get; set; }

    public TextData? TextOutput { get; set; }

    public bool HighlightToolMenu { get; set; }

    async Task OnFileAsync(BinData data)
    {
        if (Tool is null)
        {
            HighlightToolMenu = true;
            return;
        }

        foreach (var output in await ToolService.ProcessFileAsync(Tool, data))
        {
            if (output is TextData textData)
            {
                TextOutput = textData;
            }

            if (output is BinData binData)
            {
                var ms = new MemoryStream(binData.Data);

                using var streamRef = new DotNetStreamReference(ms);
                await JS.InvokeVoidAsync("downloadFileFromStream", binData.FileName, streamRef);
                continue;
            }

            if (output is GbxData gbxData)
            {
                var ms = new MemoryStream(gbxData.Data);

                using var streamRef = new DotNetStreamReference(ms);
                await JS.InvokeVoidAsync("downloadFileFromStream", gbxData.FileName, streamRef);
                continue;
            }

            if (output is Gbx gbx)
            {
                var ms = new MemoryStream();

                gbx.Save(ms);
                ms.Position = 0;

                using var streamRef = new DotNetStreamReference(ms);
                await JS.InvokeVoidAsync("downloadFileFromStream", gbx.FilePath, streamRef);
                continue;
            }
        }
    }

    void OnDragEnd()
    {
        HighlightToolMenu = false;
    }

    string GetTitle()
    {
        var title = "Gbx I/O";
        var toolName = string.IsNullOrEmpty(Tool)
            ? null : ToolService.GetTool(Tool)?.Name;

        if (toolName is not null)
        {
            title += $" - {toolName}";
        }

        return title;
    }
}
